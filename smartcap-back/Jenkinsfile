pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                dir('backend') {
                    sh '''
                        chmod +x gradlew
                        ./gradlew build -x test
                    '''
                }
            }
        }

        stage('Docker Build & Deploy') {
            steps {
                withCredentials([
                    string(credentialsId: 'DATABASE_URL', variable: 'DB_URL'),
                    string(credentialsId: 'DATABASE_USERNAME', variable: 'DB_USERNAME'),
                    string(credentialsId: 'DATABASE_PASSWORD', variable: 'DB_PASSWORD')
                ]) {
                    sh '''
                        docker stop smartcap-backend || true
                        docker rm smartcap-backend || true
                        docker rmi smartcap-backend || true
                        docker build -t smartcap-backend .

                        docker network inspect smartcap-network >/dev/null 2>&1 || \
                        docker network create smartcap-network

                        docker run -d \
                            --name smartcap-backend \
                            --network smartcap-network \
                            -p 8080:8080 \
                            -v smartcap-backend-volume:/app/data \
                            -e DB_URL=$DB_URL \
                            -e DB_USERNAME=$DB_USERNAME \
                            -e DB_PASSWORD=$DB_PASSWORD \
                            smartcap-backend
                    '''
                }
            }
        }
    }
}
